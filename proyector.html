<html>
  <head></head>
  <script src="/socket.io/socket.io.js"></script>
  <body style="margin: 0px;">
    <object type="image/scg+xml" data="images/icomoon.svg"></object>
    <canvas id="canvas" width="1024" height="1024"></canvas>
  <script>
    class Elements {
      constructor () {
      }

      coordTranslation (coordx, coordy) {
        return [(coordx + 150) * 1024 / 300, (coordy + 150) * 1024 / 300]
      };

      redraw () {
        ctx.clearRect(0, 0, 1024, 1024);
        var img = new Image();
        img.onload = function() {
          ctx.drawImage(img, 0, 0, 1024, 1024);

          for (var i = 0; i < canvasElements.length; i++) {
            canvasElements[i].drawElement();
          }
        };
        img.src = "images/pnoa.jpg";

      }

      remove () {
        var index = canvasElements.indexOf(this);
        canvasElements.splice(index, 1);
        this.redraw();
      }

      pushElem () {

          canvasElements.push( this );

      }

    }

    class Icon extends Elements {

      constructor (icon) {

        super();
        this.coords = icon.coords;
        this.iconType = icon.type;
        this._id = icon._id;
        this.type = 'icon';

      }
      
      async loadSVG() {

        let response = await fetch('images/icomoon.svg');
        return await response.text();

      }

      drawElement() {

        this.loadSVG().then((data) => {

          const parser = new DOMParser();
          const xml = parser.parseFromString( data, "application/xml" );
          const iconData = xml.querySelector(`glyph[glyph-name=${this.iconType}]`).getAttribute('d');

          let p = new Path2D( iconData );
          ctx.save();
          const [x, y] = this.coordTranslation( this.coords.x, this.coords.z );
          ctx.translate( x + 15, y + 15 );
          ctx.scale( 0.04, 0.04 );
          ctx.rotate( Math.PI );
          ctx.fillStyle = 'white';
          ctx.fill( p );
          ctx.strokeStyle = 'black';
          ctx.lineWidth = 30;
          ctx.stroke( p );
          ctx.restore();
        
        });

      }

      //drawElement () {
      //  var icon = new Image();
      //  const [x, y] = this.coordTranslation(this.coords.x, this.coords.y);
//
 //       icon.onload = function() {
    //      ctx.drawImage(icon, x - 25, y - 25, 50, 50);
  //      }
   //     icon.src = 'images/iconos/' + this.iconType + '.png';
     //   canvasElements.push(this);
      //}
    }

    class Line extends Elements {
      constructor (line) {
        super();
        this.coords = line.positions;
        this.color = [ line.red, line.green, line.blue ];
        this._id = line.id;
        this.type = 'line';
      }

      drawElement () {
        ctx.beginPath();
        var startPoint = this.coordTranslation(this.coords[0].x, this.coords[0].z);
        ctx.moveTo(startPoint[0], startPoint[1]);

        for (var i=1; i < this.coords.length; i++) {
          const [x, y] = this.coordTranslation(this.coords[i].x, this.coords[i].z);
          ctx.lineTo(x, y);
        }

        const color = this.color.map( function( x ) { return Math.floor( x * 255 ) } );
        ctx.strokeStyle = 'rgb( ' +  color[0] + ', ' +  color[1] + ', ' + color[2] + ')';
        ctx.lineWidth = 5;
        ctx.stroke();
      }
    }
      
    var socket = io();
    var ctx = document.getElementById('canvas').getContext('2d');
    var img = new Image();

    img.onload = function() {
      ctx.drawImage(img, 0, 0, 1024, 1024);
    };

    img.src = "images/pnoa.jpg";
    canvasElements = [];

    socket.on('icon', function(iconEmitted) {
      var i = new Icon(iconEmitted);
      i.drawElement();
      i.pushElem();
    });

    socket.on('linea', function( linea ) {
      console.log( linea );
      var l = new Line( linea );
      console.log( l );
      l.drawElement();
      l.pushElem();
    });

    socket.on('remove', function(ob) {

      var elemToErase = canvasElements.filter( function(elem) {
        return elem._id == ob.id && elem.type == ob.type;
      });
      elemToErase[0].remove();
      console.log( elemToErase[0] );
    });

  </script>
  <!-- <video id="video" src="/images/video.webm" controls="false"></video>-->
  </body>
</html>
